name: Windows Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test-windows:
    name: Windows (Swift 5.10.1 via Docker Action)
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Swift 5.10.1 in Docker (Windows Server 2022)
        uses: addnab/docker-run-action@v3
        with:
          image: swift:5.10.1-windowsservercore-ltsc2022
          run: |
            choco install zlib -y
            swift --version
            swift build
            swift test --parallel

      - name: Run specific test groups
        uses: addnab/docker-run-action@v3
        with:
          image: swift:5.10.1-windowsservercore-ltsc2022
          run: |
            choco install zlib -y
            swift test --filter CoreTests
            swift test --filter ExtensionsTests
            swift test --filter FileOperationsTests
            swift test --filter ErrorHandlingTests
            swift test --filter StreamingTests
            swift test --filter ConcurrencyTests

      - name: Build CLI tool
        uses: addnab/docker-run-action@v3
        with:
          image: swift:5.10.1-windowsservercore-ltsc2022
          run: |
            choco install zlib -y
            swift build --product SwiftZlibCLI

  # Build verification - Windows
  build-verification-windows:
    name: Build Verification (Windows)
    strategy:
      matrix:
        configuration: [debug, release]
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and test package
        uses: addnab/docker-run-action@v3
        with:
          image: swift:5.10.1-windowsservercore-ltsc2022
          run: |
            choco install zlib -y
            swift build -c ${{ matrix.configuration }}
            swift test -c ${{ matrix.configuration }}
            swift build -c ${{ matrix.configuration }} --product SwiftZlibCLI

  # Performance benchmarks - Windows
  benchmark-windows:
    name: Performance Benchmarks (Windows)
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run performance tests
        uses: addnab/docker-run-action@v3
        with:
          image: swift:5.10.1-windowsservercore-ltsc2022
          run: |
            choco install zlib -y
            swift test --filter PerformanceTests --verbose
            swift test --filter "testCompressionPerformance" --verbose
            swift test --filter "testDecompressionPerformance" --verbose
            swift test --filter "testMemoryEfficiency" --verbose
